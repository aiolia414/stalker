<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Stalker by pandemicsyn</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Stalker</h1>
        <h2>A simpler monitoring system experiment </h2>
        <a href="https://github.com/pandemicsyn/stalker" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a name="stalker-monitoring-system---poc" class="anchor" href="#stalker-monitoring-system---poc"><span class="octicon octicon-link"></span></a>Stalker Monitoring System - PoC</h1>

<p>Components:</p>

<ul>
<li>stalker_agent - Runs on the clients, registers the client with the master, executes local checks.</li>
<li>stalkerweb - Client registration end point and Web UI</li>
<li>stalker_manager - Just parses the master db and puts work on the queue for the runners.</li>
<li>stalker_runner - Reads work queue, hits clients stalker_agent to run checks, schedules checks next run, takes care of notifications.</li>
<li>MongoDB (its what I had installed...could be anything else). Just stores check states and host config info.</li>
<li>Redis - Could do without now, but handy if we run multiple stalker_runners down the road</li>
</ul><h2>
<a name="stalker_agentpy" class="anchor" href="#stalker_agentpy"><span class="octicon octicon-link"></span></a>stalker_agent.py</h2>

<p>stalker_agent.py runs on all client boxes. On boot it looks in stalker-agent.conf for defined checks, but you can also just drop scripts in <code>script_dir</code> and it will automatically use them as well . Once its discovered what checks should be run it notifies stalkerweb and reports what checks it found installed and configured, and at what interval they should be run at. It then fires
up a wsgi app on port 5050 to listen for requests to run installed checks. You can trigger a check be run like so:</p>

<pre><code>fhines@ubuntu:~/stalker (master)[virt]$ http http://localhost:5050/check_load X-CHECK-KEY:canhazstatus
HTTP/1.1 200 OK
Content-Length: 173
Content-Type: application/json
Date: Mon, 25 Mar 2013 04:36:44 GMT

{
    "check_load": {
        "err": "", 
        "out": "OK - load average: 0.01, 0.08, 0.12|load1=0.010;1.000;2.000;0; load5=0.080;5.000;10.000;0; load15=0.120;10.000;15.000;0;", 
        "status": 0
    }
}
</code></pre>

<h2>
<a name="stalkerweb" class="anchor" href="#stalkerweb"><span class="octicon octicon-link"></span></a>stalkerweb</h2>

<p>Stalkerweb simply listens for agents to register themselves and then inserts their info (hostname, src ip, checks to run,
roles, etc) into a central database. In addition it also exposes a simple web interface and api to query for active
checks or configured hosts. In addition to the UI running on http://stalkerweb:5000/ theres also a few api calls exposed that return a JSON response:</p>

<table>
<thead><tr>
<th>URI</th>
<th>Description</th>
<th>Methods</th>
</tr></thead>
<tbody>
<tr>
<td>/global/clusters</td>
<td>Config info for all known stalker clusters</td>
<td>GET</td>
</tr>
<tr>
<td>/stats</td>
<td>Statistics for local instance</td>
<td>GET</td>
</tr>
<tr>
<td>/stats/</td>
<td>Statistics for remote stalker clusters</td>
<td>GET</td>
</tr>
<tr>
<td>/findhost</td>
<td>Just used for the type ahead when</td>
<td>GET</td>
</tr>
<tr>
<td>/register/</td>
<td>stalker_agent registration end point</td>
<td>POST</td>
</tr>
<tr>
<td>/hosts/</td>
<td>All hosts</td>
<td>GET</td>
</tr>
<tr>
<td>/hosts/[hostname]</td>
<td>Config for a specific host</td>
<td>GET</td>
</tr>
<tr>
<td>/checks/</td>
<td>All checks</td>
<td>GET</td>
</tr>
<tr>
<td>/checks/host/[hostname]</td>
<td>checks matching to a specific host or ip</td>
<td>GET</td>
</tr>
<tr>
<td>/checks/id/[checkid]</td>
<td>A specific check</td>
<td>GET, DELETE</td>
</tr>
<tr>
<td>/checks/id/[checkid]/next</td>
<td>Get or Set next run time</td>
<td>GET, POST</td>
</tr>
<tr>
<td>/checks/id/[checkid]/suspended</td>
<td>Get or Set suspend state</td>
<td>GET, POST</td>
</tr>
<tr>
<td>/checks/state/[state]</td>
<td>All checks for a given state [alerting, pending, in_maintenance]</td>
<td>GET</td>
</tr>
<tr>
<td>/global//checks/state/</td>
<td>All checks for a given state in a remote stalker claster</td>
<td>GET</td>
</tr>
<tr>
<td>/user/</td>
<td>List all users</td>
<td>GET</td>
</tr>
<tr>
<td>/user/</td>
<td>List/Modify/Delete a user</td>
<td>GET, POST, DELETE</td>
</tr>
<tr>
<td>/routes/list</td>
<td>Get a list of all available flask routes</td>
<td>GET</td>
</tr>
</tbody>
</table><h2>
<a name="stalker_manager" class="anchor" href="#stalker_manager"><span class="octicon octicon-link"></span></a>stalker_manager</h2>

<p>stalker-manager is charge of scheduling checks with runners. At the moment it really just checks the db for checks that need to be run and drop's them on a Redis queue.</p>

<h2>
<a name="stalker_runner" class="anchor" href="#stalker_runner"><span class="octicon octicon-link"></span></a>stalker_runner</h2>

<p>It pulls checks out of a Redis list. Then makes the http call for the check to the agent. It parses the result and updates the database accordingly (i.e. marking a check as failed, setting the next run time, etc). It also does basic flap detection, and handles notifications using any enabled notification plugins.</p>

<h2>
<a name="notification-plugins" class="anchor" href="#notification-plugins"><span class="octicon octicon-link"></span></a>Notification Plugins</h2>

<ul>
<li>Pagerduty Incident API (Support's triggering and resolving)</li>
<li>Mailgun API</li>
<li>Email via smtplib</li>
<li>Shell Command Execution*</li>
<li>HTTP POST*</li>
</ul><h2>
<a name="todos" class="anchor" href="#todos"><span class="octicon octicon-link"></span></a>TODO's</h2>

<p>See issues. (Theres lots)</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/pandemicsyn/stalker/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/pandemicsyn/stalker/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/pandemicsyn/stalker"></a> is maintained by <a href="https://github.com/pandemicsyn">pandemicsyn</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>