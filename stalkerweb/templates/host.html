{% extends "base.html" %}
{% block head %}

    <script>
      target = "{{ target }}";
      function AppViewModel() {
        var self = this;
        self.hostname = ko.observable();
        self.hostip = ko.observable('0.0.0.0');
        self.host_roles = ko.observableArray([]);
        self.checks = ko.observableArray([]);
      }
      function loadHost() {
        $.ajax({type: "GET",
                url: "/hosts/" + target,
                dataType: "json",
                success: function(data) {
                  self.hostname(data['hostname'])
                  self.hostip(data['ip'])
                  self.host_roles.removeAll()
                  for (i in data['roles']) {
                    role = data['roles'][i]
                    self.host_roles.push({'name': role, 'url': '/roles/' + role})
                  }
                }
        })
      }
      function loadChecks() {
        $.ajax({type: "GET",
                url: "/checks/" + target,
                dataType: "json",
                success: function(data) {
                  self.checks.removeAll()
                  for (var i in data.checks) {
                    check_fields = {"check": null, "in_maintenance": null, "interval": null, "last": null, "next": null, "pending": null, "status": null, "flapping": null, "suspended": null, "out": null}
                    raw = data.checks[i]
                    for (i in raw) {
                      if (i in check_fields) {
                        if (i == 'last' || i == 'next') {
                          check_fields[i] = new Date(raw[i]*1000).toUTCString();
                        } else {
                          check_fields[i] = raw[i]
                        }
                      }
                    }
                    self.checks.push(check_fields)
                  }
                }
        })
      }
      loadHost();
      loadChecks();
      var interval = setInterval(loadChecks, 5000);
    </script>

{% endblock %}
{% block body %}

    <div class="container-fluid">
      
      <div class="row-fluid">
        <div class="page-header">
            <h1><span data-bind="text: self.hostname"></span> (<span data-bind="text: self.hostip"></span>)
              <!-- <div data-bind="foreach: self.host_roles">
                 <span class="label" data-bind="text: name"></span>
              </div> -->
            </h1>
        </div>
      </div>

      <div class="row-fluid">
        <table class="table table-striped table-bordered table-hover">
          <thead>
            <tr>
              <th>check</th>
              <th>maintenance</th>
              <th>interval</th>
              <th>last</th>
              <th>next</th>
              <th>pending</th>
              <th>status</th>
              <th>flapping</th>
              <th>suspended</th>
              <th>output</th>
            </tr>
          </thead>
          <tbody data-bind="foreach: checks">
            <tr>
              <td><span class="label" data-bind="text: check, css: {'label-important': !status, 'label-info': pending, 'label-warning': suspended}"></span></td>
              <td><span data-bind="text: in_maintenance"></span></td>
              <td><span data-bind="text: interval"></span></td>
              <td><span data-bind="text: last"></span></td>
              <td><span data-bind="text: next"></span></td>
              <td><span data-bind="text: pending"></span></td>
              <td><span data-bind="text: status"></span></td>
              <td><span data-bind="text: flapping"></span></td>
              <td><span data-bind="text: suspended"></span></td>
              <td><span data-bind="text: out"></span></td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="row-fluid">
        <span class="label label-important"> Failing Check</span>
        <span class="label label-info"> Pending Check </span>
        <span class="label label-warning"> Suspended Check </span>
      </div>


    </div> <!-- /container -->
    
    <script>
      ko.applyBindings(AppViewModel());
    </script>
{% endblock %}

